---

Статистики, що мають асимптотично нормальний розподiл, дисперсiю якого можна просто оцiнити: вибіркове середнє, вибіркова дисперсія

Дослідження всіх даних у одній колонці:	aqi, so2, co, o3, pm10, pm2.5, no2, nox, no, windspeed, windirec

Дослідження частини даних у одній колонці (або різних груп даних з однієї колонки): aqi по рег. за 16, 17, 23 і 24 роки, aqi по рег. до та після реформи, aqi впродовж доби, aqi по місяцях. (різниця середніх)

---

## Імпортуємо бібліотеки.
```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(latex2exp)
library(msm)
library(dplyr)
library(here)
library(knitr)
library(tibble)
library(ggplot2)
library(xtable)

path <- here("code", "lab2", "1-4-part", "plots")
dir.create(path, recursive = TRUE, showWarnings = FALSE)
```


## Імпортуємо дані. Використовуємо набір даних - tidy та робимо зріз на 10000 рядків.
```{r}
dt <- readRDS(here("data", "processed", "air_quality_tidy.rds"))# %>% slice_sample(n=10000)
#str(dt)
```


```{r}
save_data_as_csv_and_latex <- function(data, name_csv_file, name_txt_file, caption = "Таблиця даних", label = "tab:data") {
  
  folder_path <- here :: here("code", "lab2", "1-4-part", "results")
  if (!dir.exists(folder_path)) {
    dir.create(folder_path, recursive = TRUE)
  }
  csv_file <- file.path(folder_path, name_csv_file)
  txt_file <- file.path(folder_path, name_txt_file)

  # Збереження даних у CSV файл
  write.csv(data, file = csv_file, row.names = FALSE)

  # Створення LaTeX таблиці та збереження у TXT файл
  latex_table <- xtable::xtable(data, caption = caption, label = label)
  print(latex_table, type = "latex", file = txt_file)

  cat("Дані збережено у CSV та TXT файли в папці:", folder_path, "\n")
}

```

# Частина 1 
Обчислення довірчих інтервалів для вибіркового середнього та вибіркової дисперсії
для всіх числових колонок.
```{r}
variables <- c("aqi", "so2", "co", "o3", "pm10", "pm2.5", 
               "no2", "nox", "no", "windspeed", "winddirec")
```

## Функція обчислення довірчих інтревалів вибіркового середнього
(асимптотика, t-розподіл)
```{r}
ci_mean <- function(x, conf.level = 0.95) {
  n <- sum(!is.na(x))
  m <- mean(x, na.rm = TRUE)
  s <- sd(x, na.rm = TRUE)
  error <- qt((1 + conf.level) / 2, df = n - 1) * s / sqrt(n)
  c(Lower = m - error, Mean = m, Upper = m + error)
}
```

## Функція обчислення довірчих інтервалів вибіркової диспесії
(через хі-квадрат)
```{r}
ci_variance <- function(x, conf.level = 0.95) {
  n <- sum(!is.na(x))
  s2 <- var(x, na.rm = TRUE)
  chi2_lower <- qchisq((1 - conf.level) / 2, df = n - 1) # нижня квантиль
  chi2_upper <- qchisq((1 + conf.level) / 2, df = n - 1) # верхня квантиль
  c(Lower = (n - 1) * s2 / chi2_lower, Variance = s2, Upper = (n - 1) * s2 / chi2_upper)
}
```

## Довірчі інтервали для середнього
Замість циклу по змінним, застосовується функція sapply.
```{r}
ci_means <- t(sapply(dt[, variables], ci_mean))
```

## Довірчі інтервали для дисперсій
Замість циклу по змінним, застосовується функція sapply.
```{r}
ci_variances <- t(sapply(dt[, variables], ci_variance))
```


## Створення датафрейму для побудови графіків.
```{r}
ci_means_df <- as_tibble(ci_means, rownames = "variable") %>%
  rename(lower = Lower, mean = Mean, upper = Upper)

save_data_as_csv_and_latex(ci_means_df, "ci_means.csv", "ci_means.txt")
```

```{r}
ci_variance_df <- as_tibble(ci_variances, rownames = "variable") %>%
  rename(lower = Lower, variance = Variance, upper = Upper)

save_data_as_csv_and_latex(ci_variance_df, "ci_variance.csv", "ci_variance.txt")
```


# Візуалізація результатів
```{r}
mean_plot <- ggplot(ci_means_df, aes(x = mean, y = reorder(variable, mean))) +
  geom_point(color = "steelblue", size = 2) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.5, color = "steelblue") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred", linewidth = 0.8) +
  labs(x = TeX("$\\bar{X}$ з 95\\% довірчим інтервалом"),
       y = "Змінна",
       title = "Довірчі інтервали для вибіркових середніх") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
  )+
  scale_x_continuous(breaks = seq(0, 170, by = 5))

ggsave(
  filename = file.path(path, "ci-means.png"), 
  plot = mean_plot, 
  width = 16, height = 10,
  bg = "white",
  dpi = 200)
```


```{r}
var_plot <- ggplot(ci_variance_df, aes(x = variance, y = reorder(variable, variance))) +
  geom_point(color = "steelblue", size = 2) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.5, color = "steelblue") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkred", linewidth = 0.8) +
  labs(x = TeX("$\\bar{X}$ з 95\\% довірчим інтервалом"),
       y = "Змінна",
       title = "Довірчі інтервали для вибіркових дисперсій") +
  theme_classic() +
  theme(
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
  )+
  scale_x_continuous(breaks = seq(0, 13000, by = 1000))

ggsave(
  filename = file.path(path, "ci-var.png"), 
  plot = var_plot, 
  width = 16, height = 10,
  bg = "white",
  dpi = 200)
```


Інтервали: Кожна змінна має точку (середнє значення) і горизонтальну лінію (довірчий інтервал). 
Чим ширше інтервал, тим більша невизначеність або варіабельність даних для цієї змінної.
Порівняння змінних: Змінні, такі як winddirec і agl, мають відносно широкі довірчі інтервали, 
що свідчить про високу варіабельність або невизначеність. Навпаки, змінні, такі як so2 і co, 
мають вузькі інтервали, що вказує на більш стабільні або точні вимірювання.


# Висновок 
## Частина 1
Довірчі інтервали для вибіркових середніх дозволяють оцінити, в якому діапазоні з заданою імовірністю знаходиться 
істинне середнє значення показника для генеральної сукупності. 
Якщо для кількох змінних інтервали не перетинаються — це вказує на статистично значущі відмінності в середніх значеннях.

Довірчі інтервали для дисперсій допомагають оцінити стабільність розсіювання даних. Аналізуючи наші результати, можна стверджувати, що 


---
# Частина 2
Вибіркове середнє для: 
- AQI по регіонам за 16,17,23,24 роки 
- AQI по регіонам до та після реформи
---

Зчитуємо лише рік з колонки date.
```{r}
dt <- dt %>%
  mutate(date = as.Date(as.character(date), format = "%Y"),
         year = year(date))
```


-  AQI по регіонам за 16,17,23,24 роки
```{r}
var <- c(2016, 2017, 2023, 2024) 

dt_filtered <- dt %>% 
  filter(year %in% var) 
```

Обчислюємо довірчі інтервали для середнього AQI по кожному року в кожному регіоні
```{r}
ci_mean_aqi <- function(y){ 
  dt_filtered %>%
    filter(year == y) %>% 
    group_by(county) %>%
    summarise(
      lower = ci_mean(aqi)[1],
      mean  = ci_mean(aqi)[2],
      upper = ci_mean(aqi)[3],
      .groups = "drop"
    ) %>%
    mutate(year = y) %>%    
    select(year, everything())
}

csv_name <- "ci_mean_aqi.csv"
txt_name <- "ci_mean_aqi_tables.tex"

# Об’єднання таблиць по всіх роках для запису резльтатів в 1 файл
for (y in var) {
  table_year <- dt_filtered %>% filter(year == y) %>% select(-year)
  
  caption <- paste("Довірчі інтервали для середнього AQI у", y, "році")
  label <- paste0("tab:aqi_", y)
  
  save_data_as_csv_and_latex(
    data = table_year,
    name_csv_file = paste0("ci_mean_aqi_", y, ".csv"),
    name_txt_file = txt_name,  
    caption = caption,
    label = label
  )
}
```


-  AQI по регіонам до та після реформи
```{r}
dt_filtered_before_ref <- dt %>% 
  filter(after_reform == FALSE)

ci_mean_aqi_before_reform <- dt_filtered_before_ref %>% 
  group_by(county) %>% 
  
  summarise(
    lower = ci_mean(aqi)[1],
    mean  = ci_mean(aqi)[2],
    upper = ci_mean(aqi)[3]   
  )

save_data_as_csv_and_latex(ci_mean_aqi_before_reform, "ci_mean_aqi_before_reform.csv", "ci_mean_aqi_before_reform.txt")
```


```{r}
dt_filtered_after_ref <- dt %>% 
  filter(after_reform == TRUE)

ci_mean_aqi_after_reform <- dt_filtered_after_ref %>% 
  group_by(county) %>% 
  summarise(
    lower = ci_mean(aqi)[1],
    mean  = ci_mean(aqi)[2],
    upper = ci_mean(aqi)[3]   
  )

save_data_as_csv_and_latex(ci_mean_aqi_after_reform, "ci_mean_aqi_after_reform.csv", "ci_mean_aqi_after_reform.txt")
```

# Висновок 
## Частина 2
Вибіркове середнє для AQI по регіонам за 16,17,23,24 роки та AQI по регіонам до та після реформи
дозволяє оцінити, в якому діапазоні з заданою імовірністю знаходиться істинне середнє значення показника для генеральної сукупності.

Вибіркове середнє для AQI по регіонам до та після реформи дозволяє оцінити,
в якому діапазоні з заданою імовірністю знаходиться істинне середнє значення показника для генеральної сукупності.
---

# Частина 3 
## Обчислення ДІ різниці середніх для 
-  AQI впродовж доби
-  AQI по місяцях 
-  AQI по регіонам до та після реформи

---

AQI впродовж доби. Фільтруємо дані відповідно до часу.
```{r}
df_daytime <- dt %>%
  mutate(
    daytime = factor(
      lubridate::hour(date) %/% 3,
      labels = c("00-03", "03-06", "06-09", "09-12", "12-15", "15-18", "18-21", "21-24")
    )
  )  
```

```{r}
df_daytime_summary <- df_daytime %>%
  group_by(daytime) %>%
  summarise(
    Mean = mean(aqi, na.rm = TRUE),
    SD = sd(aqi, na.rm = TRUE),
    N = n(),
    Lower = Mean - qt(0.975, N-1) * SD / sqrt(N),
    Upper = Mean + qt(0.975, N-1) * SD / sqrt(N)
  )

save_data_as_csv_and_latex(df_daytime_summary, "df_daytime_summary.csv", "df_daytime_summary.txt")
```

Візуалізація результатів
```{r}
daytime_summary <- ggplot(df_daytime_summary, aes(x = daytime, y = Mean)) +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.2, color = "steelblue") +
  theme_minimal() +
  labs(
    title = "Середній AQI впродовж доби",
    x = "Час доби",
    y = "Середній AQI"
  )

ggsave(
  filename = file.path(path, "daytime_summary.png"), 
  plot = daytime_summary, 
  width = 16, height = 10,
  bg = "white",
  dpi = 200)
```


AQI по місяцях. Фільтруємо дані відповідно до місяця.
```{r}
df_seasonal <- dt %>%
  mutate(month = lubridate::month(date, label = TRUE))

#df_seasonal[, "month"]
```

```{r}
df_seasonal_summary <- df_seasonal %>%
  group_by(month) %>%
  summarise(
    Mean = mean(aqi, na.rm = TRUE),
    SD = sd(aqi, na.rm = TRUE),
    N = n(),
    Lower = Mean - qt(0.975, N-1) * SD / sqrt(N),
    Upper = Mean + qt(0.975, N-1) * SD / sqrt(N)
  )

save_data_as_csv_and_latex(df_seasonal_summary, "df_seasonal_summary.csv", "df_seasonal_summary.txt")
```


Візуалізація результатів
```{r}
seasonal_summary <- ggplot(df_seasonal_summary, aes(x = month, y = Mean)) +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.2, color = "darkgreen") +
  theme_minimal() +
  labs(
    title = "Середній AQI по місяцях",
    x = "Місяць",
    y = "Середній AQI"
  )

ggsave(
  filename = file.path(path, "seasonal_summary.png"), 
  plot = seasonal_summary, 
  width = 16, height = 10,
  bg = "white",
  dpi = 200)
```


AQI по регіонам до та після реформи
```{r}
dt_summary <- dt %>% 
  group_by(county, after_reform) %>% 
  summarise(
    Mean = mean(aqi, na.rm = TRUE),
    SD = sd(aqi, na.rm = TRUE),
    N = n(),
    Lower = Mean - qt(0.975, N-1) * SD / sqrt(N),
    Upper = Mean + qt(0.975, N-1) * SD / sqrt(N)
  ) 

save_data_as_csv_and_latex(dt_summary, "dt_summary.csv", "dt_summary.txt")
```

```{r}
dt_diff <- dt %>% 
  group_by(county, after_reform) %>% 
  summarise(
    Mean = mean(aqi, na.rm = TRUE),
    SD = sd(aqi, na.rm = TRUE),
    N = n()
  ) %>%
  pivot_wider(names_from = after_reform, values_from = c(Mean, SD, N)) %>%
  mutate(
    Diff = Mean_TRUE - Mean_FALSE,
    SE_diff = sqrt((SD_TRUE^2 / N_TRUE) + (SD_FALSE^2 / N_FALSE)),
    Lower = Diff - qt(0.975, pmin(N_TRUE, N_FALSE) - 1) * SE_diff,
    Upper = Diff + qt(0.975, pmin(N_TRUE, N_FALSE) - 1) * SE_diff
  )

save_data_as_csv_and_latex(dt_diff, "dt_diff.csv", "dt_diff.txt")
```


Візуалізація результатів
```{r}
aqi_ref_summary <- ggplot(dt_summary, aes(x = after_reform, y = Mean, color = after_reform)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.2) +
  facet_wrap(~ county) +
  theme_minimal() +
  labs(
    title = "Середній AQI до та після реформи по регіонах",
    x = "Після реформи (TRUE / FALSE)",
    y = "Середній AQI"
  ) +
  scale_color_manual(values = c("FALSE" = "yellow", "TRUE" = "steelblue"))

ggsave(
  filename = file.path(path, "aqi_ref_summary.png"), 
  plot = aqi_ref_summary, 
  width = 16, height = 10,
  bg = "white",
  dpi = 200)
```

Візуалізація результатів
```{r}
ggplot(dt_diff, aes(x = county, y = Diff)) +
  geom_point(size = 3, color = "steelblue") +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.2, color = "steelblue") +
  theme_minimal() +
  labs(
    title = "Різниця середніх AQI до та після реформи по регіонах",
    x = "Регіон",
    y = "Різниця середніх (після - до)"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed")
```

# Висновок 
## Частина 3
-  AQI впродовж доби
  + 
  + 
  + 

-  AQI по місяцях 
  + 
  + 
  + 

-  AQI по регіонам до та після реформи
  + 
  + 
  + 