```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(anytime)  # Перетворення формату дати
library(naniar)  # Заміна значень на NA
```

# Перший огляд датасету

Одразу бачимо, що є числові колонки, які зчиталися, як текстові. `Warning` пропонує застосувати функцію `problems`, щоб дізнатися, що пішло не так під час спроби розпарсити значення колонок csv файлу.

```{r load_raw, message = FALSE}
df <- read_csv("../../data/raw/air_quality.csv")
glimpse(df)
```
\pagebreak

# Parsing issues

Застосування функції `problems` показало, що:

* іноді замість порожнього значення використовується "-" або "ND". Через це відповідні колонки стають текстовими
* трапляється неправильний формат дати (роздільник `/` замість очікуваного `-`).

```{r}
problems(df)
```
\vspace{12pt}

До функції `read_csv` додано аргумент `na`, який вказує, що значення "", "-" і "ND" треба сприймати як порожні. Виправлено формат дати. Колонки `sitename`, `county`, `pollutant` і `status` перетворено на категорійні. Проблеми із типами даних на цьому вирішено.

```{r load_fixed_formats}
df <- read_csv(
  "../data/raw/air_quality.csv",
  na = c("", "-", "ND"),
  col_types = c(date = "character")
)

df$date <- anytime(df$date)

df <- df %>% mutate(
  sitename = as.factor(sitename),
  county = as.factor(county),
  pollutant = as.factor(pollutant),
  status = factor(status, levels=c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous"))
)

glimpse(df)
```
\pagebreak

# Виявлення закодованих і неадекватних значень

## Дослідження колонки "sitename"

Проблем не виявлено

```{r, R.options = list(max.print = 20)}
table(df$sitename)
```

## Дослідження колонки "county"

Проблем не виявлено

```{r}
table(df$county)
```

## Дослідження колонки "aqi"

Очевидно кодові значення: -1

```{r, R.options = list(max.print = 20)}
table(df$aqi)
```
\vspace{12pt}

Рядки, де `aqi == -1`, майже повністю заповнені NA.

```{r}
df %>% filter(aqi == -1) %>% select(!c(0:3))
```
\vspace{12pt}

Який відсоток, займаються такі рядки? Менше 0.2%.

```{r}
mean(df$aqi == -1, na.rm = TRUE)
```


## Дослідження колонки "pollutant"

Проблем не виявлено

```{r}
table(df$pollutant)
```

## Дослідження колонки "status"

Проблем не виявлено

```{r}
table(df$status)
```

## Дослідження колонки "so2"

Очевидно кодові значення: -999. Є підозрілі від'ємні числа. Можна припустити, що від'ємні показники є наслідком неідеалньості калібрування датчиків (тобто вони є справжніми, а не кодовими). Також у датасеті зафіксовані значно більші за модулем додатні концентрації, тому зсув показників є незначним.

```{r}
table(df$so2)
```

## Дослідження колонки "co"

Очевидно кодові значення: -999. Є від'ємні числа.

```{r}
table(filter(df, co < 0)$co)
```

## Дослідження колонки "o3"

Очевидно кодові значення: -999. Є від'ємні числа.

```{r}
table(filter(df, o3 < 0)$o3)
```

## Дослідження колонки "o3_8hr"

Є від'ємне число -1. Хоча воно і схоже на кодове, за аналогією до попередніх колонок, припустимо, що воно справжнє. До того ж, частка таких рядків дуже мала: у цьому можна переконатися, поглянувши на гістограму.

```{r}
table(filter(df, o3_8hr < 0)$o3_8hr)
```

```{r}
ggplot(df, aes(x = o3_8hr)) +
  geom_histogram()
```


## Дослідження колонки "pm10"

Очевидно кодові значення: -999

```{r}
table(filter(df, pm10 < 0)$pm10)
```

## Дослідження колонки "pm2.5"

Очевидно кодові значення: -999

```{r}
table(filter(df, pm2.5 < 0)$pm2.5)
```

## Дослідження колонки "no2"

Є від'ємні числа.

```{r}
table(filter(df, no2 < 0)$no2)
```

## Дослідження колонки "nox"

Є від'ємні числа.

```{r}
table(filter(df, nox < 0)$nox)
```

## Дослідження колонки "no"

Є від'ємні числа.

```{r}
table(filter(df, no < 0)$no)
```

## Дослідження колонки "windspeed"

Є від'ємні числа.

```{r}
table(filter(df, windspeed < 0)$windspeed)
```

## Дослідження колонки "winddirec"

Очевидно кодові значення: 990

```{r}
table(filter(df, winddirec < 0 | winddirec > 360)$winddirec)
```
\vspace{12pt}

Рядки, де `winddirec == 990`, у всьому іншому на вигляд цілком адекватні.
```{r}
df %>% filter(winddirec == 990) %>% select(!c(0:3))
```

## Дослідження колонки "unit"

Усі NA. Колонку можна буде видалити.

```{r}
table(df$unit)
```

## Дослідження колонки "co_8hr"

Є від'ємні числа.

```{r}
table(filter(df, co_8hr < 0)$co_8hr)
```

## Дослідження колонки "pm2.5_avg"

Є від'ємні числа.

```{r}
table(filter(df, pm2.5_avg < 0)$pm2.5_avg)
```

## Дослідження колонки "pm10_avg"

Є від'ємні числа.

```{r}
table(filter(df, pm10_avg < 0)$pm10_avg)
```

## Дослідження колонки "so2_avg"

Є від'ємні числа.

```{r}
table(filter(df, so2_avg < 0)$so2_avg)
```

## Дослідження колонки "longitude"

Значення 0 схоже на помилкове. Колонку можна буде видалити, оскільки цю інформацію навряд чи вдасться використати.

```{r, R.options = list(max.print = 20)}
table(df$longitude)
```

## Дослідження колонки "latitude"

Значення 0 схоже на помилкове. Колонку можна буде видалити, оскільки цю інформацію навряд чи вдасться використати.

```{r, R.options = list(max.print = 20)}
table(df$latitude)
```

## Дослідження колонки "siteid"

Проблем не виявлено. Колонку можна буде видалити, оскільки цю інформацію навряд чи вдасться використати.

```{r}
table(df$siteid)
```

## Підбиття підсумків, очищення від кодів і видалення непотрібних колонок

Колонки, що містять очевидно кодові значення:

* aqi - кодові: -1
* so2 - кодові: -999
* co - кодові: -999
* o3 - кодові: -999
* pm10 - кодові: -999
* pm2.5 - кодові: -999
* winddirec - кодові: 990

Колонки, що містять від'ємні значення:

* so2
* co
* o3
* o3_8hr
* no2
* nox
* no
* windspeed
* co_8hr
* pm2.5_avg
* pm10_avg
* so2_avg

Колонки, які можна видалити:

* unit - порожня колонка
* longitude - корисність під сумнівом
* latitude - корисність під сумнівом
* siteid - корисність під сумнівом

Припуститимо, що від'ємні показники є справжніми, а не кодовими, і виникли через незначний зсув у калібруванні датчиків. За неохідності (наприклад, для логаритмування) цей зсув можна буде компенсувати додаванням певного числа до всіх значень відповідної колонки.
\vspace{12pt}

Кодові значення замінимо на NA і видалимо непотрібні колонки.

```{r}
df <- df %>%
  replace_with_na(replace = list(
    aqi = -1,
    so2 = -999,
    co = -999,
    o3 = -999,
    pm10 = -999,
    pm2.5 = -999,
    winddirec = 990
  ))

df <- df %>% select(!c(unit, longitude, latitude, siteid))
```

# Оцінка кількості пропущених значень

Колонки, у яких NA більше, ніж 5%

```{r}
df %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  select(where(~ all(. > 0.05)))
```

# Повний код для підготовки даних

Повний код знаходиться у папці `code/lab1_cleaning.R`